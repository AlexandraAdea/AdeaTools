{% load static %}
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Admin – AdeaTools{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/adeastyle.css' %}">
    {% block head_extra %}{% endblock %}
</head>
<body>
    <div class="admin-layout-no-sidebar">
        <!-- Top Navigation Bar -->
        <header class="admin-topbar-full">
            <div style="display: flex; align-items: center; gap: 24px; max-width: 1400px; margin: 0 auto; width: 100%;">
                {% if user.is_staff %}
                <a href="{% url 'admin-dashboard' %}" style="font-size: 1.3em; font-weight: 600; color: #1d1d1f; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                    <span>⚙️</span>
                    <span>AdeaTools</span>
                </a>
                {% else %}
                <a href="{% url 'home' %}" style="font-size: 1.3em; font-weight: 600; color: #1d1d1f; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                    <span>AdeaTools</span>
                </a>
                {% endif %}
                <nav style="display: flex; gap: 4px; flex: 1;">
                    {% if user.is_staff %}
                    <a href="{% url 'admin-dashboard' %}" class="top-nav-item {% if request.resolver_match.url_name == 'admin-dashboard' %}active{% endif %}">Dashboard</a>
                    {% endif %}
                    <a href="{% url 'adeazeit:timeentry-day' %}" class="top-nav-item {% if 'timeentry' in request.resolver_match.url_name %}active{% endif %}">Zeiteinträge</a>
                    {% if adeazeit_is_manager %}
                    <a href="{% url 'adearechnung:client-summary' %}" class="top-nav-item {% if 'adearechnung' in request.resolver_match.app_name %}active{% endif %}">Fakturierung</a>
                    {% endif %}
                    <a href="{% url 'adeazeit:task-list' %}" class="top-nav-item {% if 'task' in request.resolver_match.url_name %}active{% endif %}">Aufgaben</a>
                    {% if user.is_staff %}
                    <a href="{% url 'adeazeit:employee-list' %}" class="top-nav-item {% if 'employee' in request.resolver_match.url_name %}active{% endif %}">Mitarbeitende</a>
                    <a href="{% url 'adeazeit:absence-list' %}" class="top-nav-item {% if 'absence' in request.resolver_match.url_name %}active{% endif %}">Abwesenheiten</a>
                    <a href="{% url 'adeazeit:servicetype-list' %}" class="top-nav-item {% if 'servicetype' in request.resolver_match.url_name %}active{% endif %}">Service-Typen</a>
                    {% endif %}
                </nav>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <a href="{% url 'home' %}" style="color: #6e6e73; text-decoration: none; font-size: 0.9em;">Zur Startseite</a>
                </div>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <main class="admin-main-no-sidebar">
            <!-- Breadcrumbs -->
            <div class="admin-breadcrumbs">
                {% block breadcrumbs %}
                {% if user.is_staff %}
                <a href="{% url 'admin-dashboard' %}">Dashboard</a>
                {% else %}
                <a href="{% url 'home' %}">Startseite</a>
                {% endif %}
                {% endblock breadcrumbs %}
            </div>
            
            <!-- Messages -->
            {% if messages %}
            <div class="admin-messages">
                {% for message in messages %}
                <div class="adea-message adea-message-{{ message.tags }}" style="margin-bottom: 12px;">
                    <span>{{ message }}</span>
                    <button onclick="this.parentElement.style.display='none'" style="background: none; border: none; font-size: 1.2em; cursor: pointer; color: inherit; opacity: 0.7;">×</button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Page Content -->
            <div class="admin-content" style="max-width: 100%; width: 100%; padding: 0 24px;">
                {% block content %}
                <section class="content-card">
                    <p>Inhalt fehlt – bitte überschreiben.</p>
                </section>
                {% endblock %}
            </div>
        </main>
    </div>
    
    {% block scripts %}{% endblock %}
    
    <!-- Session Heartbeat: Verlängert Session automatisch während aktiver Eingabe -->
    <script>
    (function() {
        'use strict';
        
        // Heartbeat alle 5 Minuten (300 Sekunden) senden
        const HEARTBEAT_INTERVAL = 5 * 60 * 1000; // 5 Minuten in Millisekunden
        const WARNING_TIME = 10 * 60 * 1000; // Warnung 10 Minuten vor Ablauf (2h - 10min = 110min)
        let heartbeatInterval = null;
        let warningShown = false;
        
        // Prüfe ob User eingeloggt ist
        {% if user.is_authenticated %}
        const isAuthenticated = true;
        {% else %}
        const isAuthenticated = false;
        {% endif %}
        
        function sendHeartbeat() {
            if (!isAuthenticated) {
                return;
            }
            
            fetch('{% url "session-heartbeat" %}', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                if (response.status === 401) {
                    // Session abgelaufen
                    clearInterval(heartbeatInterval);
                    showSessionExpiredWarning();
                } else if (response.ok) {
                    // Session verlängert
                    warningShown = false;
                }
            })
            .catch(error => {
                console.error('Heartbeat-Fehler:', error);
                // Bei Fehler weiter versuchen (Netzwerk-Probleme)
            });
        }
        
        function showSessionExpiredWarning() {
            // Zeige Warnung dass Session abgelaufen ist
            const warningDiv = document.createElement('div');
            warningDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ff3b30;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 400px;
                font-size: 14px;
            `;
            warningDiv.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">⚠️ Session abgelaufen</div>
                <div style="margin-bottom: 12px;">Ihre Sitzung ist abgelaufen. Bitte speichern Sie Ihre Eingaben und melden Sie sich erneut an.</div>
                <a href="{% url 'login' %}" style="color: white; text-decoration: underline; font-weight: 500;">Zur Anmeldung</a>
            `;
            document.body.appendChild(warningDiv);
            
            // Entferne Warnung nach 10 Sekunden
            setTimeout(() => {
                if (warningDiv.parentNode) {
                    warningDiv.parentNode.removeChild(warningDiv);
                }
            }, 10000);
        }
        
        function showSessionWarning() {
            if (warningShown) {
                return;
            }
            warningShown = true;
            
            const warningDiv = document.createElement('div');
            warningDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ff9500;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 400px;
                font-size: 14px;
            `;
            warningDiv.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">⏰ Session läuft bald ab</div>
                <div>Ihre Sitzung läuft in ca. 10 Minuten ab. Bitte speichern Sie Ihre Eingaben.</div>
                <button onclick="this.parentElement.remove()" style="margin-top: 8px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Verstanden</button>
            `;
            document.body.appendChild(warningDiv);
            
            // Entferne Warnung nach 30 Sekunden automatisch
            setTimeout(() => {
                if (warningDiv.parentNode) {
                    warningDiv.parentNode.removeChild(warningDiv);
                }
            }, 30000);
        }
        
        // Starte Heartbeat wenn User eingeloggt ist
        if (isAuthenticated) {
            // Erster Heartbeat nach 1 Minute
            setTimeout(sendHeartbeat, 60 * 1000);
            
            // Dann alle 5 Minuten
            heartbeatInterval = setInterval(sendHeartbeat, HEARTBEAT_INTERVAL);
            
            // Warnung nach 110 Minuten (10 Minuten vor Ablauf bei 2h Session)
            setTimeout(showSessionWarning, 110 * 60 * 1000);
            
            // Heartbeat auch bei Tastatur-Eingaben (für längere Formulare)
            let inputActivityTimeout = null;
            document.addEventListener('keydown', function() {
                clearTimeout(inputActivityTimeout);
                inputActivityTimeout = setTimeout(sendHeartbeat, 30 * 1000); // Nach 30 Sekunden Inaktivität
            });
            
            // Heartbeat auch bei Maus-Bewegungen
            document.addEventListener('mousemove', function() {
                clearTimeout(inputActivityTimeout);
                inputActivityTimeout = setTimeout(sendHeartbeat, 30 * 1000);
            });
        }
        
        // Cleanup beim Verlassen der Seite
        window.addEventListener('beforeunload', function() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
        });
    })();
    </script>
</body>
</html>

