{% load static %}
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}AdeaTools{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Zentrale Plattform f√ºr Zeiterfassung, CRM und Lohnabrechnung">
    <meta name="theme-color" content="#007aff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AdeaTools">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="{% static 'icons/icon-192.png' %}">
    <link rel="apple-touch-icon" href="{% static 'icons/icon-192.png' %}">
    
    <link rel="stylesheet" href="{% static 'css/adeastyle.css' %}">
    {% block head_extra %}{% endblock %}
</head>
<body>
        <!-- Hauptnavigation -->
        <nav class="adea-navbar">
            <div class="adea-navbar-container">
                <div class="adea-navbar-left">
                    <a href="{% url 'home' %}" class="adea-navbar-brand">AdeaTools</a>
                    <div class="adea-navbar-links">
                        <a href="{% url 'adeadesk:client-list' %}" class="adea-nav-link {% if request.path|slice:":6" == '/desk/' %}active{% endif %}">AdeaDesk</a>
                        <a href="{% url 'adeazeit:timeentry-day' %}" class="adea-nav-link {% if request.path|slice:":6" == '/zeit/' %}active{% endif %}">AdeaZeit</a>
                        {% if can_access_adelohn %}
                        <a href="{% url 'adealohn:payroll-list' %}" class="adea-nav-link {% if request.path|slice:":6" == '/lohn/' %}active{% endif %}">AdeaLohn</a>
                        {% endif %}
                    </div>
                </div>
                <div class="adea-navbar-right">
                    {% if user.is_authenticated %}
                    <!-- Laufender Timer -->
                    {% if running_timer %}
                    <div class="timer-display" id="timer-display">
                        <span class="timer-icon">üü¢</span>
                        <span class="timer-time" id="timer-time">00:00:00</span>
                        <button onclick="stopTimer()" class="timer-stop-btn" title="Timer stoppen">‚èπ</button>
                    </div>
                    {% endif %}
                    <div class="adea-user-menu">
<span class="adea-user-name">
                            <strong>{{ user.get_full_name|default:user.username }}</strong>
                        </span>
                        <a href="{% url 'global-logout' %}" class="adea-link-danger">Abmelden</a>
                    </div>
                    {% else %}
                    <a href="{% url 'adeazeit:login' %}" class="adea-link">Anmelden</a>
                    {% endif %}
                </div>
            </div>
        </nav>
        
        <!-- Mandanten-Info f√ºr AdeaLohn -->
        {% if request.path|slice:":6" == "/lohn/" %}
        <div class="adea-client-bar">
            <div class="adea-client-bar-container">
                <div class="adea-client-info">
                    {% if current_client %}
                        <strong>Mandant:</strong> <span class="adea-client-name">{{ current_client.name }}</span>
                        <a href="{% url 'adealohn:client_switch' %}" class="adea-link" style="margin-left: var(--spacing-md);">Mandant wechseln</a>
                    {% else %}
                        <span class="adea-text-secondary">Kein Mandant ausgew√§hlt</span>
                        <a href="{% url 'adealohn:client_switch' %}" class="adea-link" style="margin-left: var(--spacing-md);">Mandant ausw√§hlen</a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    <div class="frame">
        <main>
            <!-- Django Messages -->
            {% if messages %}
            <div class="adea-messages-container">
                {% for message in messages %}
                <div class="adea-message adea-message-{{ message.tags }}">
                    <span>{{ message }}</span>
                    <button onclick="this.parentElement.style.display='none'" class="adea-message-close">√ó</button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% block content %}
            <section class="content-card">
                <p>Inhalt fehlt ‚Äì bitte √ºberschreiben.</p>
            </section>
            {% endblock %}
        </main>

        <footer>¬© 2025 AdeaTools ‚Äì entwickelt f√ºr Treuhandb√ºro Ivanova</footer>
        {% block scripts %}{% endblock %}
    </div>
    
    <!-- Timer JavaScript -->
    {% if running_timer %}
    <script>
        // Timer-Daten
        const timerStartTime = new Date("{{ running_timer.start_time|date:'c' }}");
        let timerInterval;
        
        // Funktion: Aktualisiere Timer-Anzeige
        function updateTimerDisplay() {
            const now = new Date();
            const diff = Math.floor((now - timerStartTime) / 1000); // Sekunden
            
            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            const seconds = diff % 60;
            
            const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('timer-time').textContent = timeString;
        }
        
        // Funktion: Stoppe Timer
        function stopTimer() {
            fetch("{% url 'adeazeit:timer-stop' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                location.reload();
            })
            .catch(error => {
                console.error('Fehler:', error);
                location.reload();
            });
        }
        
        // Starte Live-Update
        updateTimerDisplay();
        timerInterval = setInterval(updateTimerDisplay, 1000); // Jede Sekunde aktualisieren
        
        // Warnung beim Browser-Schlie√üen
        window.addEventListener('beforeunload', function(e) {
            e.preventDefault();
            e.returnValue = 'Timer l√§uft noch! Wirklich schlie√üen?';
            return 'Timer l√§uft noch! Wirklich schlie√üen?';
        });
    </script>
    {% endif %}
    
    <!-- PWA Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker error:', err));
        }
    </script>
</body>
</html>

