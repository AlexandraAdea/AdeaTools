{% extends 'base.html' %}

{% block title %}Payroll {{ month_name }} {{ record.year }} ‚Äì AdeaLohn{% endblock %}

{% block content %}
<section class="content-card">
    <div class="adea-d-flex-between">
        <div>
            <h1>{{ month_name }} {{ record.year }}</h1>
            <p class="lead">Mitarbeiter: {{ record.employee.first_name }} {{ record.employee.last_name }} ¬∑ Client: {{ record.employee.client.name }}</p>
            <div style="margin-top: 8px;">
                <strong>Status:</strong> 
                {% if record.status == 'ENTWURF' %}
                <span style="padding: 4px 12px; border-radius: 4px; font-size: 0.9em; background: #e3f2fd; color: #1976d2;">
                    {{ record.get_status_display }}
                </span>
                {% elif record.status == 'GEPRUEFT' %}
                <span style="padding: 4px 12px; border-radius: 4px; font-size: 0.9em; background: #fff3e0; color: #f57c00;">
                    {{ record.get_status_display }}
                </span>
                {% elif record.status == 'ABGERECHNET' %}
                <span style="padding: 4px 12px; border-radius: 4px; font-size: 0.9em; background: #e8f5e9; color: #388e3c;">
                    {{ record.get_status_display }}
                </span>
                {% elif record.status == 'GESPERRT' %}
                <span style="padding: 4px 12px; border-radius: 4px; font-size: 0.9em; background: #ffebee; color: #d32f2f;">
                    {{ record.get_status_display }}
                </span>
                {% endif %}
            </div>
            {% if record.is_locked %}
            <div style="margin-top: 12px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                <strong>‚ö†Ô∏è Gesperrt:</strong> Dieser Lohnlauf ist gesperrt ({{ record.get_status_display }}) und kann nicht mehr bearbeitet werden.
            </div>
            {% endif %}
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <a class="adea-button-secondary" href="{% url 'adealohn:payroll-print' record.pk %}" target="_blank">üìÑ Lohnabrechnung drucken</a>
            {% if not record.is_locked %}
                <a class="adea-button-primary" href="{% url 'adealohn:payroll-update' record.pk %}">Bearbeiten</a>
                <a class="adea-button-primary" style="background:#ff5f57;" href="{% url 'adealohn:payroll-delete' record.pk %}">L√∂schen</a>
            {% else %}
                <span style="color: #8e8e93; font-size: 0.9em;">Bearbeitung gesperrt</span>
            {% endif %}
        </div>
    </div>

    <div class="feature-grid" style="margin-top:24px;">
        <div class="feature-item">
            <h2>Lohnabrechnung</h2>
            {% if lohnwirksame_items %}
                <div class="adea-table-wrapper" style="box-shadow:none; margin-bottom: 16px;">
                    <table class="adea-table">
                        <thead>
                            <tr>
                                <th>Lohnart</th>
                                <th>Menge</th>
                                <th>Betrag</th>
                                <th>Total</th>
                                <th>Beschreibung</th>
                                {% if not record.is_locked %}
                                <th style="width: 80px;">Aktionen</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in lohnwirksame_items %}
                            <tr>
                                <td>{{ item.wage_type.name }}</td>
                                <td>{{ item.quantity|floatformat:2 }}</td>
                                <td>{{ item.amount|floatformat:2 }} CHF</td>
                                <td><strong>{{ item.total|floatformat:2 }} CHF</strong></td>
                                <td>{{ item.description|default:"‚Äì" }}</td>
                                {% if not record.is_locked %}
                                <td>
                                    <a href="{% url 'adealohn:payroll_item_delete' item.pk %}" 
                                       class="adea-button-secondary" 
                                       style="padding: 4px 8px; font-size: 0.85em; background: #ff5f57; color: white; border: none;"
                                       onclick="return confirm('Sind Sie sicher, dass Sie diese Lohnart l√∂schen m√∂chten?');">
                                        L√∂schen
                                    </a>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr style="border-top: 2px solid rgba(0,0,0,0.2);">
                                <td colspan="3" style="text-align: right; padding-top: 8px; font-weight: bold;">
                                    <strong>Bruttolohn gesamt:</strong>
                                </td>
                                <td style="padding-top: 8px; font-weight: bold;">
                                    <strong>{{ record.bruttolohn|floatformat:2 }} CHF</strong>
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            {% else %}
                <p style="color:#8e8e93;">Keine Lohnbestandteile erfasst.</p>
            {% endif %}
            
            {% if nicht_lohnwirksame_items %}
                <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.1);">
                    <h3 style="font-size: 1em; margin-bottom: 12px; color: #666;">Manuelle Abz√ºge/Korrekturen</h3>
                    <div class="adea-table-wrapper" style="box-shadow:none;">
                        <table class="adea-table">
                            <thead>
                                <tr>
                                    <th>Art</th>
                                    <th>Menge</th>
                                    <th>Betrag</th>
                                    <th>Total</th>
                                    <th>Beschreibung</th>
                                    {% if not record.is_locked %}
                                    <th style="width: 80px;">Aktionen</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in nicht_lohnwirksame_items %}
                                <tr>
                                    <td>{{ item.wage_type.name }}</td>
                                    <td>{{ item.quantity|floatformat:2 }}</td>
                                    <td>{{ item.amount|floatformat:2 }} CHF</td>
                                    <td><strong>{{ item.total|floatformat:2 }} CHF</strong></td>
                                    <td>{{ item.description|default:"‚Äì" }}</td>
                                    {% if not record.is_locked %}
                                    <td>
                                        <a href="{% url 'adealohn:payroll_item_delete' item.pk %}" 
                                           class="adea-button-secondary" 
                                           style="padding: 4px 8px; font-size: 0.85em; background: #ff5f57; color: white; border: none;"
                                           onclick="return confirm('Sind Sie sicher, dass Sie diese Lohnart l√∂schen m√∂chten?');">
                                            L√∂schen
                                        </a>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
            
            {% if not record.is_locked %}
            <div style="margin-top: 16px;">
                <a class="adea-button-primary" href="{% url 'adealohn:payroll_item_create' record.pk %}">
                    + Lohnart hinzuf√ºgen
                </a>
            </div>
            {% endif %}
        </div>
        <div class="feature-item">
            <h2>√úbersicht</h2>
            <ul>
                {% if record.employee.hourly_rate > 0 %}
                <li><strong>Stundensatz:</strong> {{ record.employee.hourly_rate|floatformat:2 }} CHF</li>
                {% endif %}
                {% if record.employee.monthly_salary > 0 %}
                <li><strong>Monatslohn:</strong> {{ record.employee.monthly_salary|floatformat:2 }} CHF</li>
                {% endif %}
                <li><strong>Monat:</strong> {{ month_name }} / {{ record.month }}</li>
                <li><strong>Jahr:</strong> {{ record.year }}</li>
                {% if hours_total > 0 %}
                <li><strong>Stunden gesamt:</strong> {{ hours_total|floatformat:2 }} h</li>
                {% endif %}
            </ul>
        </div>
        <div class="feature-item">
            <h2>AHV-Berechnung</h2>
            <ul>
                <li><strong>AHV-Basis:</strong> {{ record.ahv_basis|floatformat:2 }} CHF</li>
                {% if record.employee.is_rentner and record.employee.ahv_freibetrag_aktiv %}
                <li><strong>Rentnerfreibetrag:</strong> 1'400.00 CHF</li>
                {% endif %}
                <li><strong>Effektive AHV-Basis:</strong> {{ record.ahv_effective_basis|floatformat:2 }} CHF</li>
                <li><strong>AHV Arbeitnehmer (5.3%):</strong> {{ record.ahv_employee|floatformat:2 }} CHF</li>
                <li><strong>AHV Arbeitgeber (5.3%):</strong> {{ record.ahv_employer|floatformat:2 }} CHF</li>
            </ul>
        </div>
        <div class="feature-item">
            <h2>ALV-Berechnung</h2>
            <ul>
                <li><strong>ALV-Basis:</strong> {{ record.alv_basis|floatformat:2 }} CHF</li>
                {% if record.employee.is_rentner %}
                <li><em style="color:#8e8e93;">Keine ALV f√ºr Rentner</em></li>
                {% else %}
                <li><strong>ALV YTD-Basis:</strong> {{ record.employee.alv_ytd_basis|floatformat:2 }} CHF</li>
                <li><strong>Effektive ALV-Basis:</strong> {{ record.alv_effective_basis|floatformat:2 }} CHF</li>
                <li><em style="color:#8e8e93; font-size:0.9em;">Max. versichertes Jahreseinkommen: 148'200 CHF</em></li>
                <li><strong>ALV Arbeitnehmer (1.1%):</strong> {{ record.alv_employee|floatformat:2 }} CHF</li>
                <li><strong>ALV Arbeitgeber (1.1%):</strong> {{ record.alv_employer|floatformat:2 }} CHF</li>
                {% endif %}
            </ul>
        </div>
        <div class="feature-item">
            <h2>UVG-Berechnung (Unfallversicherung)</h2>
            <ul>
                <li><strong>UV-Basis:</strong> {{ record.uv_basis|floatformat:2 }} CHF</li>
                <li><strong>UVG YTD-Basis:</strong> {{ record.employee.uvg_ytd_basis|floatformat:2 }} CHF</li>
                <li><strong>Effektive UV-Basis:</strong> {{ record.uvg_effective_basis|floatformat:2 }} CHF</li>
                <li><em style="color:#8e8e93; font-size:0.9em;">Max. versichertes Jahreseinkommen: 148'200 CHF</em></li>
                <li><strong>BU Arbeitgeber:</strong> {{ record.bu_employer|floatformat:2 }} CHF</li>
                {% if record.employee.weekly_hours <= 8 %}
                <li><em style="color:#8e8e93;">Keine NBU-Pflicht bei ‚â§8h/Woche</em></li>
                {% else %}
                <li><strong>NBU Arbeitnehmer:</strong> {{ record.nbu_employee|floatformat:2 }} CHF</li>
                {% endif %}
            </ul>
        </div>
        <div class="feature-item">
            <h2>KTG-Berechnung (Krankentaggeldversicherung)</h2>
            <ul>
                <li><strong>KTG-Basis (UV-Basis):</strong> {{ record.uv_basis|floatformat:2 }} CHF</li>
                <li><strong>Effektive KTG-Basis:</strong> {{ record.ktg_effective_basis|floatformat:2 }} CHF</li>
                {% if record.ktg_employee == 0 and record.ktg_employer == 0 %}
                <li><em style="color:#8e8e93;">Keine KTG-Beitr√§ge konfiguriert</em></li>
                {% else %}
                <li><strong>KTG Arbeitnehmer:</strong> {{ record.ktg_employee|floatformat:2 }} CHF</li>
                <li><strong>KTG Arbeitgeber:</strong> {{ record.ktg_employer|floatformat:2 }} CHF</li>
                {% endif %}
            </ul>
        </div>
        <div class="feature-item">
            <h2>BVG-Beitr√§ge (berufliche Vorsorge, 2. S√§ule)</h2>
            <ul>
                {% if bvg_params %}
                    <li><strong>BVG-Basis (monatlich):</strong> {{ record.bvg_basis|floatformat:2 }} CHF</li>
                    <li><strong>BVG YTD-Basis:</strong> {{ record.employee.bvg_ytd_basis|floatformat:2 }} CHF</li>
                    <li><strong>Jahreslohn (YTD + aktuell):</strong> {{ annual_salary|floatformat:2 }} CHF</li>
                    <li><strong>Eintrittsschwelle:</strong> {{ bvg_params.entry_threshold|floatformat:2 }} CHF</li>
                    {% if record.bvg_insured_salary == 0 %}
                    <li><em style="color:#8e8e93;">Unter Eintrittsschwelle ‚Äì keine BVG-Pflicht</em></li>
                    {% else %}
                    <li><strong>BVG YTD versicherter Lohn:</strong> {{ record.employee.bvg_ytd_insured_salary|floatformat:2 }} CHF</li>
                    <li><strong>Koordinationsabzug:</strong> {{ bvg_params.coordination_deduction|floatformat:2 }} CHF</li>
                    <li><strong>Versicherter Lohn (j√§hrlich):</strong> {{ record.bvg_insured_salary|floatformat:2 }} CHF</li>
                    <li><em style="color:#8e8e93; font-size:0.9em;">Korridor: {{ bvg_params.min_insured_salary|floatformat:2 }} ‚Äì {{ bvg_params.max_insured_salary|floatformat:2 }} CHF</em></li>
                    <li><strong>BVG-Satz AN:</strong> {{ bvg_employee_rate_percent|floatformat:2 }}%</li>
                    <li><strong>BVG-Satz AG:</strong> {{ bvg_employer_rate_percent|floatformat:2 }}%</li>
                    {% if record.manual_bvg_employee > 0 or record.manual_bvg_employer > 0 %}
                    <li style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">
                        <strong style="color:#007aff;">Berechnet + Manuell:</strong>
                        <br>AN: {{ record.bvg_employee|floatformat:2 }} CHF (davon manuell: {{ record.manual_bvg_employee|floatformat:2 }} CHF)
                        <br>AG: {{ record.bvg_employer|floatformat:2 }} CHF (davon manuell: {{ record.manual_bvg_employer|floatformat:2 }} CHF)
                    </li>
                    {% else %}
                    <li><strong>BVG Arbeitnehmer:</strong> {{ record.bvg_employee|floatformat:2 }} CHF</li>
                    <li><strong>BVG Arbeitgeber:</strong> {{ record.bvg_employer|floatformat:2 }} CHF</li>
                    {% endif %}
                    {% endif %}
                {% else %}
                    <li><em style="color:#8e8e93;">Keine BVG-Parameter f√ºr {{ record.year }} konfiguriert ‚Äì nur manuelle Beitr√§ge</em></li>
                {% endif %}
                
                {% if record.manual_bvg_employee > 0 or record.manual_bvg_employer > 0 %}
                <li style="margin-top: 12px; padding-top: 12px; border-top: 2px solid rgba(0,0,0,0.2);">
                    <strong style="color:#007aff; font-size:1.1em;">Manuelle BVG-Beitr√§ge:</strong>
                    {% if record.manual_bvg_employee > 0 %}
                    <br><strong>BVG Arbeitnehmer:</strong> {{ record.manual_bvg_employee|floatformat:2 }} CHF
                    {% endif %}
                    {% if record.manual_bvg_employer > 0 %}
                    <br><strong>BVG Arbeitgeber:</strong> {{ record.manual_bvg_employer|floatformat:2 }} CHF
                    {% endif %}
                </li>
                {% elif not bvg_params %}
                <li style="margin-top: 12px; padding: 12px; background: #e8f4f8; border-left: 4px solid #007aff; border-radius: 4px;">
                    <strong>‚ÑπÔ∏è Hinweis:</strong> Bitte BVG-Beitr√§ge im Bearbeitungsformular erfassen.
                </li>
                {% endif %}
                
                {% if not record.is_locked %}
                <li style="margin-top: 16px; padding-top: 16px; border-top: 2px solid rgba(0,0,0,0.2);">
                    <a class="adea-button-primary" href="{% url 'adealohn:payroll-update' record.pk %}" style="text-decoration: none; display: inline-block;">
                        ‚úèÔ∏è BVG-Beitr√§ge bearbeiten
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
        <div class="feature-item">
            <h2>Quellensteuer (QST)</h2>
            <ul>
                {% if record.employee.qst_pflichtig %}
                    <li><strong>Tarif (effektiv):</strong> {{ record.employee.qst_effective_tarif|default:"‚Äì" }}</li>
                    <li><strong>Tarif (eingegeben):</strong> {{ record.employee.qst_tarif|default:"‚Äì" }}</li>
                    <li><strong>Kinder:</strong> {{ record.employee.qst_kinder }}</li>
                    <li><strong>Kirchensteuer:</strong> {{ record.employee.qst_kirchensteuer|yesno:"Ja,Nein" }} 
                        <em style="color:#8e8e93; font-size:0.9em;">(im Tarif kodiert: {{ record.employee.qst_kirchensteuer|yesno:"Y,N" }})</em></li>
                    <li><strong>QST-Basis:</strong> {{ record.qst_basis|floatformat:2 }} CHF</li>
                    <li><strong>QST-Betrag:</strong> <strong>{{ record.qst_abzug|floatformat:2 }} CHF</strong></li>
                    {% if record.employee.qst_fixbetrag %}
                        <li><em style="color:#8e8e93; font-size:0.9em;">Fixbetrag verwendet</em></li>
                    {% elif record.qst_prozent %}
                        <li><em style="color:#8e8e93; font-size:0.9em;">Prozentsatz: {{ record.qst_prozent|floatformat:2 }}%</em></li>
                    {% elif record.employee.qst_tarif %}
                        <li><em style="color:#8e8e93; font-size:0.9em;">Berechnet aus QSTParameter (Tarif: {{ record.employee.qst_effective_tarif }})</em></li>
                    {% endif %}
                {% else %}
                    <li><em style="color:#8e8e93;">Keine Quellensteuerpflicht</em></li>
                {% endif %}
            </ul>
        </div>
        <div class="feature-item">
            <h2>Familienzulagen</h2>
            {% if laufende_zulagen or nachzahlungen %}
                {% if laufende_zulagen %}
                    <h3 style="font-size: 1em; margin-top: 12px; margin-bottom: 8px; color: #333;">Laufende Zulagen</h3>
                    <div class="adea-table-wrapper" style="box-shadow:none; margin-bottom: 16px;">
                        <table class="adea-table">
                            <thead>
                                <tr>
                                    <th>Zulagenart</th>
                                    <th>Menge</th>
                                    <th>Betrag</th>
                                    <th>Total</th>
                                    <th>Beschreibung</th>
                                    {% if not record.is_locked %}
                                    <th style="width: 80px;">Aktionen</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in laufende_zulagen %}
                                <tr>
                                    <td>{{ item.wage_type.name }}</td>
                                    <td>{{ item.quantity|floatformat:2 }}</td>
                                    <td>{{ item.amount|floatformat:2 }} CHF</td>
                                    <td><strong>{{ item.total|floatformat:2 }} CHF</strong></td>
                                    <td>{{ item.description|default:"‚Äì" }}</td>
                                    {% if not record.is_locked %}
                                    <td>
                                        <a href="{% url 'adealohn:payroll_item_delete' item.pk %}" 
                                           class="adea-button-secondary" 
                                           style="padding: 4px 8px; font-size: 0.85em; background: #ff5f57; color: white; border: none;"
                                           onclick="return confirm('Sind Sie sicher, dass Sie diese Familienzulage l√∂schen m√∂chten?');">
                                            L√∂schen
                                        </a>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                
                {% if nachzahlungen %}
                    <h3 style="font-size: 1em; margin-top: 12px; margin-bottom: 8px; color: #333;">Nachzahlungen</h3>
                    <div class="adea-table-wrapper" style="box-shadow:none; margin-bottom: 16px;">
                        <table class="adea-table">
                            <thead>
                                <tr>
                                    <th>Zulagenart</th>
                                    <th>Monate</th>
                                    <th>Monatsbetrag</th>
                                    <th>Total</th>
                                    <th>Beschreibung</th>
                                    {% if not record.is_locked %}
                                    <th style="width: 80px;">Aktionen</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in nachzahlungen %}
                                <tr>
                                    <td>{{ item.wage_type.name }}</td>
                                    <td>{{ item.quantity|floatformat:0 }}</td>
                                    <td>{{ item.amount|floatformat:2 }} CHF</td>
                                    <td><strong>{{ item.total|floatformat:2 }} CHF</strong></td>
                                    <td>{{ item.description|default:"‚Äì" }}</td>
                                    {% if not record.is_locked %}
                                    <td>
                                        <a href="{% url 'adealohn:payroll_item_delete' item.pk %}" 
                                           class="adea-button-secondary" 
                                           style="padding: 4px 8px; font-size: 0.85em; background: #ff5f57; color: white; border: none;"
                                           onclick="return confirm('Sind Sie sicher, dass Sie diese Nachzahlung l√∂schen m√∂chten?');">
                                            L√∂schen
                                        </a>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                
                <div style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 8px; margin-top: 8px;">
                    <strong>Summe Familienzulagen: {{ zulagen_total|floatformat:2 }} CHF</strong>
                </div>
            {% else %}
                <p style="color:#8e8e93;">Keine Familienzulagen erfasst.</p>
            {% endif %}
            
            {% if not record.is_locked %}
            <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                <a class="adea-button-primary" href="{% url 'adealohn:payroll-family-allowance-laufend' record.pk %}">
                    + Laufende Zulage hinzuf√ºgen
                </a>
                <a class="adea-button-secondary" href="{% url 'adealohn:payroll-family-allowance-nachzahlung' record.pk %}">
                    + Nachzahlung hinzuf√ºgen
                </a>
            </div>
            {% endif %}
            <p style="color:#8e8e93; font-size:0.9em; margin-top: 8px;">
                <em>Nachzahlungen werden immer im Monat der Auszahlung abgerechnet (FamZG).</em>
            </p>
        </div>
        <div class="feature-item">
            <h2>Auszahlung (Herleitung)</h2>
            <ul>
                <li><strong>Bruttolohn:</strong> {{ record.bruttolohn|floatformat:2 }} CHF</li>
                <li><strong>AHV Abzug:</strong> -{{ record.ahv_employee|floatformat:2 }} CHF</li>
                <li><strong>ALV Abzug:</strong> -{{ record.alv_employee|floatformat:2 }} CHF</li>
                <li><strong>NBU Abzug:</strong> -{{ record.nbu_employee|floatformat:2 }} CHF</li>
                <li><strong>KTG Abzug:</strong> -{{ record.ktg_employee|floatformat:2 }} CHF</li>
                <li><strong>BVG Abzug:</strong> -{{ record.bvg_employee|floatformat:2 }} CHF</li>
                {% if record.qst_abzug > 0 %}
                <li><strong>QST Abzug:</strong> -{{ record.qst_abzug|floatformat:2 }} CHF</li>
                {% elif record.qst_abzug == 0 and record.employee.qst_pflichtig %}
                <li><strong>QST Abzug:</strong> 0.00 CHF</li>
                {% endif %}
                <li style="border-top:1px solid rgba(0,0,0,0.1); padding-top:8px; margin-top:8px;"><strong>Nettolohn:</strong> {{ record.nettolohn|floatformat:2 }} CHF</li>
                {% if privatanteile_total > 0 %}
                <li><strong>Privatanteile Abzug:</strong> -{{ privatanteile_total|floatformat:2 }} CHF</li>
                {% endif %}
                {% if zulagen_total > 0 %}
                <li><strong>Zulagen (FamZG):</strong> +{{ zulagen_total|floatformat:2 }} CHF</li>
                {% endif %}
                {% if summe_spesen > 0 %}
                <li><strong>Spesen:</strong> +{{ summe_spesen|floatformat:2 }} CHF</li>
                {% endif %}
                <li style="border-top:2px solid rgba(0,0,0,0.2); padding-top:8px; margin-top:8px; font-size:1.1em;">
                    <strong>Auszahlung:</strong> {{ auszahlung|floatformat:2 }} CHF
                </li>
            </ul>
        </div>
    </div>

    <div class="feature-item" style="margin-top:24px;">
        <h2>Spesen</h2>
        {% if spesen_items %}
            <div class="adea-table-wrapper" style="box-shadow:none; margin-bottom: 16px;">
                <table class="adea-table">
                    <thead>
                        <tr>
                            <th>Spesenart</th>
                            <th>Betrag</th>
                            <th>Beschreibung</th>
                            <th>Status</th>
                            {% if not record.is_locked %}
                            <th style="width: 80px;">Aktionen</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in spesen_items %}
                        <tr>
                            <td>{{ item.wage_type.name }}</td>
                            <td><strong>{{ item.amount|floatformat:2 }} CHF</strong></td>
                            <td>{{ item.description|default:"‚Äì" }}</td>
                            <td>
                                {% if item.wage_type.ahv_relevant %}
                                    <span style="color: #ff9500;">AHV-pflichtig</span>
                                {% else %}
                                    <span style="color: green;">AHV-frei</span>
                                {% endif %}
                            </td>
                            {% if not record.is_locked %}
                            <td>
                                <a href="{% url 'adealohn:payroll_item_delete' item.pk %}" 
                                   class="adea-button-secondary" 
                                   style="padding: 4px 8px; font-size: 0.85em; background: #ff5f57; color: white; border: none;"
                                   onclick="return confirm('Sind Sie sicher, dass Sie diese Spesen l√∂schen m√∂chten?');">
                                    L√∂schen
                                </a>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr style="border-top: 1px solid rgba(0,0,0,0.1);">
                            <td colspan="{% if not record.is_locked %}5{% else %}4{% endif %}" style="text-align: right; padding-top: 8px;">
                                <strong>Summe Spesen: {{ summe_spesen|floatformat:2 }} CHF</strong>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        {% else %}
            <p style="color:#8e8e93;">Keine Spesen erfasst.</p>
        {% endif %}
        
        {% if not record.is_locked %}
        <div style="margin-top: 16px;">
            <a class="adea-button-secondary" href="{% url 'adealohn:payroll_spesen_create' record.pk %}">
                + Spesen hinzuf√ºgen
            </a>
        </div>
        {% endif %}
    </div>

    <div class="feature-item" style="margin-top:24px;">
        <h2>Privatanteile</h2>
        {% if privatanteil_items %}
            <div class="adea-table-wrapper" style="box-shadow:none; margin-bottom: 16px;">
                <table class="adea-table">
                    <thead>
                        <tr>
                            <th>Art</th>
                            <th>Betrag</th>
                            <th>Beschreibung</th>
                            {% if not record.is_locked %}
                            <th style="width: 80px;">Aktionen</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in privatanteil_items %}
                        <tr>
                            <td>{{ item.wage_type.name }}</td>
                            <td><strong>{{ item.amount|floatformat:2 }} CHF</strong></td>
                            <td>{{ item.description|default:"‚Äì" }}</td>
                            {% if not record.is_locked %}
                            <td>
                                <a href="{% url 'adealohn:payroll_item_delete' item.pk %}" 
                                   class="adea-button-secondary" 
                                   style="padding: 4px 8px; font-size: 0.85em; background: #ff5f57; color: white; border: none;"
                                   onclick="return confirm('Sind Sie sicher, dass Sie diesen Privatanteil l√∂schen m√∂chten?');">
                                    L√∂schen
                                </a>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr style="border-top: 1px solid rgba(0,0,0,0.1);">
                            <td colspan="{% if not record.is_locked %}4{% else %}3{% endif %}" style="text-align: right; padding-top: 8px;">
                                <strong>Summe Privatanteile: {{ privatanteile_total|floatformat:2 }} CHF</strong>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        {% else %}
            <p style="color:#8e8e93;">Keine Privatanteile erfasst.</p>
        {% endif %}
        
        {% if not record.is_locked %}
        <div style="margin-top: 16px;">
            <a class="adea-button-secondary" href="{% url 'adealohn:payroll_privatanteil_create' record.pk %}">
                + Privatanteil hinzuf√ºgen
            </a>
        </div>
        {% endif %}
    </div>

    <div class="feature-item" style="margin-top:24px;">
        <h2>Zeiteintr√§ge ({{ time_records|length }})</h2>
        <div class="adea-table-wrapper" style="box-shadow:none;">
            <table class="adea-table">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Projekt</th>
                        <th>Stunden</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in time_records %}
                    <tr>
                        <td>{{ item.date|date:"d.m.Y" }}</td>
                        <td>{% if item.project %}{{ item.project.name }}{% else %}Allgemein{% endif %}</td>
                        <td>{{ item.hours|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">Keine Zeiteintr√§ge f√ºr diesen Zeitraum.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="feature-item" style="margin-top:24px;">
        <h2>Weitere Lohnarten</h2>
        <p style="color:#8e8e93; margin-bottom: 16px;">
            Hier k√∂nnen Sie weitere Lohnarten hinzuf√ºgen: Pr√§mien, Trinkgeld, BVG-Zusatzbeitr√§ge, 
            Zulagen, etc. Diese werden automatisch in die Berechnung einbezogen.
        </p>
        {% if not record.is_locked %}
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <a class="adea-button-primary" href="{% url 'adealohn:payroll_item_create' record.pk %}">
                + Lohnart hinzuf√ºgen
            </a>
        </div>
        {% else %}
        <p style="color:#8e8e93;">Bearbeitung gesperrt</p>
        {% endif %}
    </div>

    <div style="margin-top:24px;">
        <a href="{% url 'adealohn:payroll-list' %}">&larr; Zur√ºck zur √úbersicht</a>
    </div>
</section>
{% endblock %}


